<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gutta Quiz â€” Leaderboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:wght@700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0a0c10;--surf:#12151d;--surf2:#1a1e2a;--surf3:#222736;
  --border:#2c3145;--accent:#4fffb0;--red:#ff5f6d;--yellow:#ffc947;
  --blue:#5eb8ff;--text:#e8eaf2;--muted:#5a6080;
  --font:'DM Sans',system-ui,sans-serif;
  --mono:'DM Mono',monospace;--display:'Fraunces',Georgia,serif;
  --gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32;
}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--bg);color:var(--text);font-family:var(--font);
  display:flex;flex-direction:column;
  padding:28px 52px 20px;
  background-image:
    radial-gradient(ellipse 70% 50% at 20% 10%,rgba(79,255,176,.07) 0%,transparent 60%),
    radial-gradient(ellipse 60% 60% at 80% 90%,rgba(94,184,255,.06) 0%,transparent 60%);
}

/* â”€â”€ HEADER â”€â”€ */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-shrink:0;}
.title{font-family:var(--display);font-size:2.6rem;font-weight:900;letter-spacing:-2px;color:var(--accent);line-height:1;}
.title span{color:var(--text);}
.subtitle{color:var(--muted);font-size:.88rem;margin-top:3px;}
.header-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:7px;}
.player-count{font-family:var(--mono);font-size:.9rem;color:var(--muted);}
.player-count strong{color:var(--accent);font-size:1.15rem;}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(79,255,176,.1);border:1px solid rgba(79,255,176,.25);border-radius:99px;padding:4px 12px;font-size:.72rem;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:blink 1.4s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}

/* â”€â”€ PODIUM â”€â”€ */
.podium-wrap{display:flex;align-items:flex-end;justify-content:center;gap:14px;margin-bottom:24px;flex-shrink:0;}
.podium-item{display:flex;flex-direction:column;align-items:center;gap:7px;flex:1;max-width:210px;}
.podium-avatar{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:900;font-family:var(--mono);border:3px solid;flex-shrink:0;}
.podium-name{font-family:var(--display);font-size:.95rem;font-weight:700;text-align:center;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.podium-score{font-family:var(--mono);font-size:1rem;font-weight:700;}
.podium-block{width:100%;border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:center;font-size:1.8rem;}
.podium-item.p1 .podium-avatar{border-color:var(--gold);background:rgba(255,215,0,.12);color:var(--gold);}
.podium-item.p1 .podium-name{color:var(--gold);}
.podium-item.p1 .podium-score{color:var(--gold);}
.podium-item.p1 .podium-block{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.25);height:110px;}
.podium-item.p2 .podium-avatar{border-color:var(--silver);background:rgba(192,192,192,.1);color:var(--silver);}
.podium-item.p2 .podium-name{color:var(--silver);}
.podium-item.p2 .podium-score{color:var(--silver);}
.podium-item.p2 .podium-block{background:rgba(192,192,192,.07);border:1px solid rgba(192,192,192,.18);height:80px;}
.podium-item.p3 .podium-avatar{border-color:var(--bronze);background:rgba(205,127,50,.1);color:var(--bronze);}
.podium-item.p3 .podium-name{color:var(--bronze);}
.podium-item.p3 .podium-score{color:var(--bronze);}
.podium-item.p3 .podium-block{background:rgba(205,127,50,.07);border:1px solid rgba(205,127,50,.18);height:56px;}
.podium-empty .podium-avatar{border-color:var(--border);background:var(--surf2);color:var(--muted);}
.podium-empty .podium-name,.podium-empty .podium-score{color:var(--muted);}
.podium-item.p1.is-leader .podium-avatar{animation:leaderPulse 2s ease-in-out infinite;}
@keyframes leaderPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,215,0,.5);}50%{box-shadow:0 0 0 12px rgba(255,215,0,0);}}

/* â”€â”€ BREAKDOWN TABLE â”€â”€ */
.breakdown-wrap{flex:1;overflow:hidden;}
.breakdown-table{width:100%;border-collapse:separate;border-spacing:0 4px;table-layout:auto;}
.breakdown-table thead th{font-size:.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding:0 4px 6px;text-align:center;}
.breakdown-table thead th.th-name{text-align:left;padding-left:14px;}
.breakdown-table thead th.th-score{text-align:right;padding-right:14px;white-space:nowrap;}
.breakdown-table tbody tr{animation:rowIn .45s cubic-bezier(.22,1,.36,1);}
@keyframes rowIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.breakdown-table tbody td{background:var(--surf);padding:9px 4px;}
.breakdown-table tbody td:first-child{border-radius:10px 0 0 10px;padding-left:14px;}
.breakdown-table tbody td:last-child{border-radius:0 10px 10px 0;padding-right:14px;}
/* Leader row highlight */
.breakdown-table tbody tr.leader-row td{background:rgba(255,215,0,.07);outline:1px solid rgba(255,215,0,.2);}
/* New player flash */
@keyframes newFlash{0%{background:rgba(79,255,176,.22);}100%{background:var(--surf);}}
.breakdown-table tbody tr.new-flash td{animation:newFlash 1.4s ease;}
.leader-row.new-flash td{animation:newFlash 1.4s ease;}

.td-rank{width:38px;text-align:center;font-family:var(--mono);font-size:.82rem;font-weight:700;color:var(--muted);}
.td-name{font-size:.92rem;font-weight:700;color:var(--text);white-space:nowrap;padding-right:8px;}
.leader-row .td-name{color:var(--gold);}
.td-q{width:24px;text-align:center;}
.ck{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;font-size:.65rem;font-weight:900;}
.ck.ok{background:rgba(79,255,176,.15);color:var(--accent);}
.ck.no{background:rgba(255,95,109,.15);color:var(--red);}
.ck.blank{opacity:.15;color:var(--muted);}
.td-score{text-align:right;font-family:var(--mono);font-size:.95rem;font-weight:700;color:var(--accent);white-space:nowrap;}
.leader-row .td-score{color:var(--gold);}

/* â”€â”€ CONFETTI â”€â”€ */
#confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:9999;}

/* â”€â”€ CONNECTING â”€â”€ */
.connecting{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:100;}
.connecting.hidden{display:none;}
.connecting-spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.connecting-text{color:var(--muted);}
.td-empty{text-align:center;color:var(--muted);padding:36px 0!important;background:transparent!important;}
</style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<div class="connecting" id="connecting">
  <div class="connecting-spinner"></div>
  <div class="connecting-text">Kobler til leaderboardâ€¦</div>
</div>

<div class="header">
  <div>
    <div class="title">Gutta<span> Quiz</span></div>
    <div class="subtitle">laget av Mathias</div>
  </div>
  <div class="header-right">
    <div class="player-count"><strong id="playerCount">0</strong> spillere ferdig</div>
    <div class="live-badge"><span class="live-dot"></span>LIVE</div>
  </div>
</div>

<div class="podium-wrap" id="podium">
  <div class="podium-item p2 podium-empty"><div class="podium-avatar">?</div><div class="podium-name">â€”</div><div class="podium-score">â€”</div><div class="podium-block" style="height:80px">ðŸ¥ˆ</div></div>
  <div class="podium-item p1 podium-empty"><div class="podium-avatar">?</div><div class="podium-name">â€”</div><div class="podium-score">â€”</div><div class="podium-block" style="height:110px">ðŸ¥‡</div></div>
  <div class="podium-item p3 podium-empty"><div class="podium-avatar">?</div><div class="podium-name">â€”</div><div class="podium-score">â€”</div><div class="podium-block" style="height:56px">ðŸ¥‰</div></div>
</div>

<div class="breakdown-wrap">
  <table class="breakdown-table">
    <thead><tr id="tableHead">
      <th class="th-name">Spiller</th>
      <th class="th-score">Score</th>
    </tr></thead>
    <tbody id="tableBody">
      <tr><td class="td-empty" colspan="3">Venter pÃ¥ spillereâ€¦ ðŸŽ®</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyALjLzP2eMSOcoop3KNRtEDFc13J57AZ_g",
  authDomain: "quiz-de49c.firebaseapp.com",
  databaseURL: "https://quiz-de49c-default-rtdb.firebaseio.com",
  projectId: "quiz-de49c",
  storageBucket: "quiz-de49c.firebasestorage.app",
  messagingSenderId: "303601116783",
  appId: "1:303601116783:web:3d57bcbfa347af9c578f9a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function initials(n){const p=n.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():n.slice(0,2).toUpperCase();}
function slugify(n){return n.toLowerCase().trim().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');}

// â”€â”€ STATE â”€â”€
let prevLeader=null, prevCount=0, numQ=0;
const prevScores={};

// â”€â”€ CONFETTI â”€â”€
const canvas=document.getElementById('confettiCanvas');
const ctx=canvas.getContext('2d');
let particles=[], rafRunning=false;
function resizeCanvas(){canvas.width=innerWidth;canvas.height=innerHeight;}
window.addEventListener('resize',resizeCanvas); resizeCanvas();

function launchConfetti(){
  const colors=['#4fffb0','#ffc947','#5eb8ff','#ff5f6d','#ffd700','#ffffff'];
  for(let i=0;i<180;i++) particles.push({
    x:Math.random()*canvas.width, y:-20,
    w:Math.random()*10+4, h:Math.random()*5+3,
    color:colors[Math.floor(Math.random()*colors.length)],
    vx:(Math.random()-.5)*5, vy:Math.random()*4+2,
    rot:Math.random()*360, vr:(Math.random()-.5)*7, life:1
  });
  if(!rafRunning) animFrame();
}
function animFrame(){
  rafRunning=true;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles=particles.filter(p=>{
    p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy+=0.09; p.life-=0.007;
    ctx.save(); ctx.globalAlpha=Math.max(0,p.life);
    ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
    ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    ctx.restore();
    return p.life>0&&p.y<canvas.height+40;
  });
  if(particles.length>0) requestAnimationFrame(animFrame);
  else rafRunning=false;
}

// â”€â”€ ANIMATED SCORE COUNTER â”€â”€
function animCount(el, from, to){
  const dur=700, start=performance.now();
  function step(now){
    const t=Math.min((now-start)/dur,1);
    const e=1-Math.pow(1-t,3);
    el.textContent=Math.round(from+(to-from)*e)+' pts';
    if(t<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// â”€â”€ PODIUM â”€â”€
const PORDER=[1,0,2], PCLS=['p2','p1','p3'], PH=[80,110,56], MEDALS=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
function renderPodium(players){
  document.getElementById('podium').innerHTML=PORDER.map(idx=>{
    const p=players[idx], cls=PCLS[idx], h=PH[idx];
    if(!p) return `<div class="podium-item ${cls} podium-empty"><div class="podium-avatar">?</div><div class="podium-name">â€”</div><div class="podium-score">â€”</div><div class="podium-block" style="height:${h}px">${MEDALS[idx]}</div></div>`;
    const isTop=idx===0;
    return `<div class="podium-item ${cls}${isTop?' is-leader':''}">
      <div class="podium-avatar">${esc(initials(p.name))}</div>
      <div class="podium-name">${esc(p.name)}</div>
      <div class="podium-score" id="ps_${idx}">${p.score} pts</div>
      <div class="podium-block" style="height:${h}px">${MEDALS[idx]}</div>
    </div>`;
  }).join('');
}

// â”€â”€ TABLE â”€â”€
function renderTable(players, newName){
  const head=document.getElementById('tableHead');
  const body=document.getElementById('tableBody');

  // Column headers
  let hh=`<th class="th-name">Spiller</th>`;
  for(let i=1;i<=numQ;i++) hh+=`<th class="td-q" style="font-size:.58rem">${i}</th>`;
  hh+=`<th class="th-score">Score</th>`;
  head.innerHTML=hh;

  if(!players.length){
    body.innerHTML=`<tr><td class="td-empty" colspan="${numQ+3}">Venter pÃ¥ spillereâ€¦ ðŸŽ®</td></tr>`;
    return;
  }

  body.innerHTML=players.map((p,i)=>{
    const rank=i+1;
    const isLeader=i===0;
    const isNew=newName&&p.name.toLowerCase().trim()===newName.toLowerCase().trim();
    const rankStr=rank===1?'ðŸ¥‡':rank===2?'ðŸ¥ˆ':rank===3?'ðŸ¥‰':rank;
    const rounds=Array.isArray(p.rounds)?p.rounds:[];
    let checks='';
    for(let q=0;q<numQ;q++){
      const r=rounds[q];
      if(!r) checks+=`<td class="td-q"><span class="ck blank">Â·</span></td>`;
      else checks+=`<td class="td-q"><span class="ck ${r.correct?'ok':'no'}">${r.correct?'âœ“':'âœ—'}</span></td>`;
    }
    const sid=`ts_${slugify(p.name)}`;
    return `<tr class="${isLeader?'leader-row':''}${isNew?' new-flash':''}" id="tr_${slugify(p.name)}">
      <td class="td-rank">${rankStr}</td>
      <td class="td-name">${esc(p.name)}</td>
      ${checks}
      <td class="td-score" id="${sid}">${p.score} pts</td>
    </tr>`;
  }).join('');

  // Animate score counters for changed scores
  players.forEach(p=>{
    const key=slugify(p.name);
    const el=document.getElementById(`ts_${key}`);
    if(!el) return;
    const prev=prevScores[key]??p.score;
    if(prev!==p.score){
      el.classList.add('score-pop');
      animCount(el, prev, p.score);
      setTimeout(()=>el.classList.remove('score-pop'),600);
    }
    prevScores[key]=p.score;
  });
}

// â”€â”€ FIREBASE LISTENER â”€â”€
onValue(ref(db,'scores'), snapshot=>{
  document.getElementById('connecting').classList.add('hidden');
  const data=snapshot.val();

  if(!data){
    document.getElementById('playerCount').textContent='0';
    return;
  }

  // Deduplicate: best score per name
  const byName={};
  Object.values(data).forEach(e=>{
    if(!e.name) return;
    const k=e.name.toLowerCase().trim();
    if(!byName[k]||e.score>byName[k].score) byName[k]=e;
  });

  const players=Object.values(byName).sort((a,b)=>b.score-a.score);
  document.getElementById('playerCount').textContent=players.length;

  // Figure out max questions
  players.forEach(p=>{ if(p.rounds) numQ=Math.max(numQ, Array.isArray(p.rounds)?p.rounds.length:0); });

  // New player = someone who appeared this update
  const newName=players.length>prevCount ? players.find(p=>!prevScores.hasOwnProperty(slugify(p.name)))?.name : null;
  prevCount=players.length;

  // Leader change â†’ confetti
  const leader=players[0]?.name?.toLowerCase().trim();
  if(leader && leader!==prevLeader && prevLeader!==null) launchConfetti();
  prevLeader=leader;

  renderPodium(players);
  renderTable(players, newName);
});
</script>
</body>
</html>

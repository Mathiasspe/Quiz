<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gutta Quiz ‚Äî Leaderboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:wght@700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0a0c10;--surf:#12151d;--surf2:#1a1e2a;--surf3:#222736;
  --border:#2c3145;--accent:#4fffb0;--red:#ff5f6d;--yellow:#ffc947;
  --blue:#5eb8ff;--text:#e8eaf2;--muted:#5a6080;
  --font:'DM Sans',system-ui,sans-serif;
  --mono:'DM Mono',monospace;--display:'Fraunces',Georgia,serif;
  --gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32;
}
html,body{height:100%;overflow:hidden;}
body{
  background:var(--bg);color:var(--text);font-family:var(--font);
  display:flex;flex-direction:column;
  padding:28px 52px 20px;
  background-image:
    radial-gradient(ellipse 70% 50% at 20% 10%,rgba(79,255,176,.07) 0%,transparent 60%),
    radial-gradient(ellipse 60% 60% at 80% 90%,rgba(94,184,255,.06) 0%,transparent 60%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-shrink:0;}
.title{font-family:var(--display);font-size:2.6rem;font-weight:900;letter-spacing:-2px;color:var(--accent);line-height:1;}
.title span{color:var(--text);}
.subtitle{color:var(--muted);font-size:.88rem;margin-top:3px;}
.header-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:7px;}
.player-count{font-family:var(--mono);font-size:.9rem;color:var(--muted);}
.player-count strong{color:var(--accent);font-size:1.15rem;}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(79,255,176,.1);border:1px solid rgba(79,255,176,.25);border-radius:99px;padding:4px 12px;font-size:.72rem;font-weight:700;color:var(--accent);letter-spacing:1px;text-transform:uppercase;}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:blink 1.4s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.2;}}

/* ‚îÄ‚îÄ PODIUM ‚îÄ‚îÄ */
.podium-wrap{display:flex;align-items:flex-end;justify-content:center;gap:14px;margin-bottom:24px;flex-shrink:0;}
.podium-item{display:flex;flex-direction:column;align-items:center;gap:7px;flex:1;max-width:210px;}
.podium-avatar{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:900;font-family:var(--mono);border:3px solid;flex-shrink:0;}
.podium-name{font-family:var(--display);font-size:.95rem;font-weight:700;text-align:center;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.podium-score{font-family:var(--mono);font-size:1rem;font-weight:700;}
.podium-block{width:100%;border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:center;font-size:1.8rem;}
.podium-item.p1 .podium-avatar{border-color:var(--gold);background:rgba(255,215,0,.12);color:var(--gold);}
.podium-item.p1 .podium-name{color:var(--gold);}
.podium-item.p1 .podium-score{color:var(--gold);}
.podium-item.p1 .podium-block{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.25);height:110px;}
.podium-item.p2 .podium-avatar{border-color:var(--silver);background:rgba(192,192,192,.1);color:var(--silver);}
.podium-item.p2 .podium-name{color:var(--silver);}
.podium-item.p2 .podium-score{color:var(--silver);}
.podium-item.p2 .podium-block{background:rgba(192,192,192,.07);border:1px solid rgba(192,192,192,.18);height:80px;}
.podium-item.p3 .podium-avatar{border-color:var(--bronze);background:rgba(205,127,50,.1);color:var(--bronze);}
.podium-item.p3 .podium-name{color:var(--bronze);}
.podium-item.p3 .podium-score{color:var(--bronze);}
.podium-item.p3 .podium-block{background:rgba(205,127,50,.07);border:1px solid rgba(205,127,50,.18);height:56px;}
.podium-empty .podium-avatar{border-color:var(--border);background:var(--surf2);color:var(--muted);}
.podium-empty .podium-name,.podium-empty .podium-score{color:var(--muted);}
.podium-item.p1.is-leader .podium-avatar{animation:leaderPulse 2s ease-in-out infinite;}
@keyframes leaderPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,215,0,.5);}50%{box-shadow:0 0 0 12px rgba(255,215,0,0);}}

/* ‚îÄ‚îÄ BREAKDOWN TABLE ‚îÄ‚îÄ */
.breakdown-wrap{flex:1;overflow:hidden;}
.breakdown-table{width:100%;border-collapse:separate;border-spacing:0 4px;table-layout:auto;}
.breakdown-table thead th{font-size:.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);padding:0 4px 6px;text-align:center;}
.breakdown-table thead th.th-name{text-align:left;padding-left:14px;}
.breakdown-table thead th.th-score{text-align:right;padding-right:14px;white-space:nowrap;}
.breakdown-table tbody tr{animation:rowIn .45s cubic-bezier(.22,1,.36,1);}
@keyframes rowIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.breakdown-table tbody td{background:var(--surf);padding:9px 4px;}
.breakdown-table tbody td:first-child{border-radius:10px 0 0 10px;padding-left:14px;}
.breakdown-table tbody td:last-child{border-radius:0 10px 10px 0;padding-right:14px;}
/* Leader row highlight */
.breakdown-table tbody tr.leader-row td{background:rgba(255,215,0,.07);outline:1px solid rgba(255,215,0,.2);}
/* New player flash */
@keyframes newFlash{0%{background:rgba(79,255,176,.22);}100%{background:var(--surf);}}
.breakdown-table tbody tr.new-flash td{animation:newFlash 1.4s ease;}
.leader-row.new-flash td{animation:newFlash 1.4s ease;}

.td-rank{width:38px;text-align:center;font-family:var(--mono);font-size:.82rem;font-weight:700;color:var(--muted);}
.td-name{font-size:.92rem;font-weight:700;color:var(--text);white-space:nowrap;padding-right:8px;}
.leader-row .td-name{color:var(--gold);}
.td-q{width:24px;text-align:center;}
.ck{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;font-size:.65rem;font-weight:900;}
.ck.ok{background:rgba(79,255,176,.15);color:var(--accent);}
.ck.no{background:rgba(255,95,109,.15);color:var(--red);}
.ck.blank{opacity:.15;color:var(--muted);}
.td-score{text-align:right;font-family:var(--mono);font-size:.95rem;font-weight:700;color:var(--accent);white-space:nowrap;}
.leader-row .td-score{color:var(--gold);}

/* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
#confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:9999;}



/* ‚îÄ‚îÄ HOST CONTROL PANEL ‚îÄ‚îÄ */
.host-panel{
  position:fixed;top:24px;left:50%;transform:translateX(-50%);
  z-index:600;
  background:rgba(18,21,29,.95);border:1px solid rgba(255,255,255,.1);
  border-radius:16px;padding:14px 20px;
  display:flex;align-items:center;gap:12px;
  backdrop-filter:blur(12px);
  box-shadow:0 8px 40px rgba(0,0,0,.6);
}
.host-label{font-size:.65rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.host-btn{
  border:none;border-radius:10px;padding:8px 16px;
  font-family:var(--font);font-size:.82rem;font-weight:700;
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.host-btn.green{background:rgba(79,255,176,.15);color:var(--accent);border:1px solid rgba(79,255,176,.3);}
.host-btn.green:hover{background:rgba(79,255,176,.25);}
.host-btn.orange{background:rgba(255,201,71,.12);color:var(--yellow);border:1px solid rgba(255,201,71,.25);}
.host-btn.orange:hover{background:rgba(255,201,71,.22);}
.host-btn.red{background:rgba(255,95,109,.12);color:var(--red);border:1px solid rgba(255,95,109,.25);}
.host-btn.red:hover{background:rgba(255,95,109,.22);}
.host-btn:disabled{opacity:.35;cursor:default;}
.host-sep{width:1px;height:28px;background:var(--border);}
.host-state{font-family:var(--mono);font-size:.78rem;color:var(--muted);}
.host-state strong{color:var(--text);}

/* ‚îÄ‚îÄ WAITING OVERLAY on leaderboard ‚îÄ‚îÄ */
.waiting-overlay{
  position:fixed;inset:0;background:rgba(10,12,16,.92);backdrop-filter:blur(6px);
  z-index:400;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  transition:opacity .4s;
}
.waiting-overlay.hidden{opacity:0;pointer-events:none;}
.waiting-title{font-family:var(--display);font-size:3rem;font-weight:900;color:var(--accent);}
.waiting-sub{color:var(--muted);font-size:1rem;}
.waiting-players{font-family:var(--mono);font-size:1.3rem;color:var(--text);}

/* ‚îÄ‚îÄ HALFTIME OVERLAY ‚îÄ‚îÄ */
.halftime-overlay{
  position:fixed;inset:0;background:rgba(10,12,16,.95);backdrop-filter:blur(10px);
  z-index:400;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;
  opacity:0;pointer-events:none;transition:opacity .4s;
}
.halftime-overlay.open{opacity:1;pointer-events:all;}
.halftime-title{font-family:var(--display);font-size:3.5rem;font-weight:900;color:var(--yellow);}
.halftime-sub{color:rgba(255,255,255,.5);font-size:1rem;margin-bottom:8px;}
.halftime-list{display:flex;flex-direction:column;gap:10px;width:min(460px,90vw);}
.halftime-row{
  display:flex;align-items:center;gap:16px;
  background:rgba(255,255,255,.05);border-radius:14px;padding:14px 20px;
  animation:rowIn .5s cubic-bezier(.22,1,.36,1) both;
}
.halftime-medal{font-size:1.6rem;width:36px;text-align:center;}
.halftime-name{font-family:var(--display);font-size:1.2rem;font-weight:700;color:#fff;flex:1;}
.halftime-progress{font-size:.78rem;color:rgba(255,255,255,.4);font-family:var(--mono);}

/* ‚îÄ‚îÄ PROGRESS INDICATOR in breakdown table ‚îÄ‚îÄ */
.prog-bar-wrap{width:36px;height:5px;background:var(--surf2);border-radius:99px;display:inline-block;vertical-align:middle;margin-left:4px;}
.prog-bar-fill{height:100%;border-radius:99px;background:var(--blue);transition:width .6s;}
.streak-fire{font-size:.8rem;margin-left:2px;}

/* ‚îÄ‚îÄ COUNTDOWN on leaderboard ‚îÄ‚îÄ */
.countdown-big{
  font-family:var(--display);font-size:8rem;font-weight:900;color:var(--accent);
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  z-index:700;pointer-events:none;opacity:0;
  animation:none;
}
.countdown-big.show{animation:cdPop .9s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes cdPop{0%{opacity:0;transform:scale(2);}40%{opacity:1;transform:scale(1);}80%{opacity:1;}100%{opacity:0;transform:scale(.8);}}

/* ‚îÄ‚îÄ QR CODE ‚îÄ‚îÄ */
.qr-corner{
  position:fixed;bottom:28px;left:40px;z-index:500;
  display:flex;flex-direction:column;align-items:center;gap:6px;
  cursor:pointer;
}
.qr-corner img{
  width:90px;height:90px;border-radius:10px;
  border:2px solid rgba(79,255,176,.35);
  box-shadow:0 4px 20px rgba(0,0,0,.6);
  transition:transform .2s,border-color .2s;
  background:#fff;padding:4px;
}
.qr-corner:hover img{transform:scale(1.08);border-color:var(--accent);}
.qr-label{font-size:.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:rgba(79,255,176,.5);}

/* Modal */
.qr-modal{
  position:fixed;inset:0;z-index:1000;
  background:rgba(0,0,0,.85);backdrop-filter:blur(8px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  opacity:0;pointer-events:none;transition:opacity .25s;
}
.qr-modal.open{opacity:1;pointer-events:all;}
.qr-modal img{
  width:280px;height:280px;border-radius:16px;
  background:#fff;padding:12px;
  box-shadow:0 20px 80px rgba(0,0,0,.8);
  animation:qrPop .35s cubic-bezier(.34,1.56,.64,1);
}
@keyframes qrPop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.qr-modal-title{font-family:var(--display);font-size:1.6rem;font-weight:900;color:#fff;}
.qr-modal-sub{font-size:.9rem;color:rgba(255,255,255,.5);}
.qr-close{margin-top:8px;background:transparent;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.5);border-radius:99px;padding:8px 24px;font-family:var(--font);font-size:.82rem;cursor:pointer;transition:all .15s;}
.qr-close:hover{border-color:var(--accent);color:var(--accent);}
/* ‚îÄ‚îÄ CONNECTING ‚îÄ‚îÄ */
.connecting{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:100;}
.connecting.hidden{display:none;}
.connecting-spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.connecting-text{color:var(--muted);}
.td-empty{text-align:center;color:var(--muted);padding:36px 0!important;background:transparent!important;}
</style>
</head>
<body>

<canvas id="confettiCanvas"></canvas>

<div class="connecting" id="connecting">
  <div class="connecting-spinner"></div>
  <div class="connecting-text">Kobler til leaderboard‚Ä¶</div>
</div>

<div class="header">
  <div>
    <div class="title">Gutta<span> Quiz</span></div>
    <div class="subtitle">laget av Mathias</div>
  </div>
  <div class="header-right">
    <div class="player-count"><strong id="playerCount">0</strong> spillere ferdig</div>
    <div class="live-badge"><span class="live-dot"></span>LIVE</div>
  </div>
</div>

<div class="podium-wrap" id="podium">
  <div class="podium-item p2 podium-empty"><div class="podium-avatar">?</div><div class="podium-name">‚Äî</div><div class="podium-score">‚Äî</div><div class="podium-block" style="height:80px">ü•à</div></div>
  <div class="podium-item p1 podium-empty"><div class="podium-avatar">?</div><div class="podium-name">‚Äî</div><div class="podium-score">‚Äî</div><div class="podium-block" style="height:110px">ü•á</div></div>
  <div class="podium-item p3 podium-empty"><div class="podium-avatar">?</div><div class="podium-name">‚Äî</div><div class="podium-score">‚Äî</div><div class="podium-block" style="height:56px">ü•â</div></div>
</div>

<div class="breakdown-wrap">
  <table class="breakdown-table">
    <thead><tr id="tableHead">
      <th class="th-name">Spiller</th>
      <th class="th-score">Score</th>
    </tr></thead>
    <tbody id="tableBody">
      <tr><td class="td-empty" colspan="3">Venter p√• spillere‚Ä¶ üéÆ</td></tr>
    </tbody>
  </table>
</div>

<!-- Host control panel -->
<div class="host-panel" id="hostPanel">
  <div class="host-label">üéÆ Host</div>
  <div class="host-state">Status: <strong id="hostStateLabel">venter</strong></div>
  <div class="host-sep"></div>
  <button class="host-btn green" id="btnStart" onclick="hostAction('countdown')">‚ñ∂ Start quiz</button>
  <button class="host-btn orange" id="btnHalftime" onclick="hostAction('halftime')" disabled>‚è∏ Halvtid</button>
  <button class="host-btn green" id="btnResume" onclick="hostAction('playing')" style="display:none">‚ñ∂ Fortsett</button>
  <button class="host-btn red" id="btnFinish" onclick="hostAction('finished')" disabled>üèÅ Avslutt</button>
  <div class="host-sep"></div>
  <button class="host-btn red" onclick="resetQuiz()" style="opacity:.5;font-size:.72rem;">‚Ü∫ Reset</button>
</div>

<!-- Waiting overlay -->
<div class="waiting-overlay hidden" id="waitingOverlay">
  <div style="font-size:4rem">‚è≥</div>
  <div class="waiting-title">Gutta Quiz</div>
  <div class="waiting-sub">Klar for quiz-kveld? Trykk Start n√•r alle er klare.</div>
  <div class="waiting-players"><span id="waitPlayerCount">0</span> spillere innmeldt</div>
</div>

<!-- Halftime overlay -->
<div class="halftime-overlay" id="halftimeOverlay">
  <div style="font-size:3rem">üèÅ</div>
  <div class="halftime-title">Halvtid!</div>
  <div class="halftime-sub">Stillingen etter 10 sp√∏rsm√•l ‚Äî poeng holdes hemmelig</div>
  <div class="halftime-list" id="halftimeList"></div>
  <div style="color:rgba(255,255,255,.3);font-size:.82rem;margin-top:8px">Trykk "Fortsett" for √• gjenoppta quizen</div>
</div>

<!-- Countdown number (big) -->
<div class="countdown-big" id="countdownBig"></div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyALjLzP2eMSOcoop3KNRtEDFc13J57AZ_g",
  authDomain: "quiz-de49c.firebaseapp.com",
  databaseURL: "https://quiz-de49c-default-rtdb.firebaseio.com",
  projectId: "quiz-de49c",
  storageBucket: "quiz-de49c.firebasestorage.app",
  messagingSenderId: "303601116783",
  appId: "1:303601116783:web:3d57bcbfa347af9c578f9a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function initials(n){const p=n.trim().split(/\s+/);return p.length>=2?(p[0][0]+p[1][0]).toUpperCase():n.slice(0,2).toUpperCase();}
function slugify(n){return n.toLowerCase().trim().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let prevLeader=null, prevCount=0, numQ=0;
const prevScores={};
let currentGameState='waiting';

// ‚îÄ‚îÄ HOST ACTIONS ‚îÄ‚îÄ
window.hostAction = function(state){
  set(ref(db,'gameState'), state);
};
window.resetQuiz = function(){
  if(!confirm('Reset leaderboard og spill? Dette sletter alle scores.')) return;
  remove(ref(db,'scores'));
  set(ref(db,'gameState'),'waiting');
};

// ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ
const canvas=document.getElementById('confettiCanvas');
const ctx=canvas.getContext('2d');
let particles=[], rafRunning=false;
function resizeCanvas(){canvas.width=innerWidth;canvas.height=innerHeight;}
window.addEventListener('resize',resizeCanvas); resizeCanvas();
function launchConfetti(){
  const colors=['#4fffb0','#ffc947','#5eb8ff','#ff5f6d','#ffd700','#ffffff'];
  for(let i=0;i<180;i++) particles.push({
    x:Math.random()*canvas.width, y:-20,
    w:Math.random()*10+4, h:Math.random()*5+3,
    color:colors[Math.floor(Math.random()*colors.length)],
    vx:(Math.random()-.5)*5, vy:Math.random()*4+2,
    rot:Math.random()*360, vr:(Math.random()-.5)*7, life:1
  });
  if(!rafRunning) animFrame();
}
function animFrame(){
  rafRunning=true; ctx.clearRect(0,0,canvas.width,canvas.height);
  particles=particles.filter(p=>{
    p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.vy+=0.09; p.life-=0.007;
    ctx.save(); ctx.globalAlpha=Math.max(0,p.life);
    ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
    ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    ctx.restore();
    return p.life>0&&p.y<canvas.height+40;
  });
  if(particles.length>0) requestAnimationFrame(animFrame);
  else rafRunning=false;
}

// ‚îÄ‚îÄ ANIMATED SCORE COUNTER ‚îÄ‚îÄ
function animCount(el, from, to){
  const dur=700, start=performance.now();
  function step(now){
    const t=Math.min((now-start)/dur,1);
    const e=1-Math.pow(1-t,3);
    el.textContent=Math.round(from+(to-from)*e)+' pts';
    if(t<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// ‚îÄ‚îÄ COUNTDOWN ON LEADERBOARD ‚îÄ‚îÄ
function showCountdown(from, onDone){
  const el=document.getElementById('countdownBig');
  let n=from;
  function tick(){
    el.textContent=n;
    el.className='countdown-big show';
    void el.offsetWidth; // reflow to restart animation
    el.className='countdown-big show';
    n--;
    if(n>=0) setTimeout(tick, 1000);
    else { el.className='countdown-big'; onDone && onDone(); }
  }
  tick();
}

// ‚îÄ‚îÄ STREAK CALCULATOR ‚îÄ‚îÄ
function getStreak(rounds){
  if(!rounds||!rounds.length) return 0;
  let streak=0;
  for(let i=rounds.length-1;i>=0;i--){
    if(rounds[i].correct) streak++;
    else break;
  }
  return streak;
}

// ‚îÄ‚îÄ PODIUM ‚îÄ‚îÄ
const PORDER=[1,0,2], PCLS=['p2','p1','p3'], PH=[80,110,56], MEDALS=['ü•á','ü•à','ü•â'];
function renderPodium(players){
  document.getElementById('podium').innerHTML=PORDER.map(idx=>{
    const p=players[idx], cls=PCLS[idx], h=PH[idx];
    if(!p) return `<div class="podium-item ${cls} podium-empty"><div class="podium-avatar">?</div><div class="podium-name">‚Äî</div><div class="podium-score">‚Äî</div><div class="podium-block" style="height:${h}px">${MEDALS[idx]}</div></div>`;
    const isTop=idx===0;
    const streak=getStreak(p.rounds);
    const fireStr=streak>=3?` üî•${streak>=5?streak:''}`:''
    return `<div class="podium-item ${cls}${isTop?' is-leader':''}">
      <div class="podium-avatar">${esc(initials(p.name))}</div>
      <div class="podium-name">${esc(p.name)}${fireStr}</div>
      <div class="podium-score" id="ps_${idx}">${p.score} pts</div>
      <div class="podium-block" style="height:${h}px">${MEDALS[idx]}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ
function renderTable(players, newName, maxQ){
  const head=document.getElementById('tableHead');
  const body=document.getElementById('tableBody');
  let hh=`<th style="width:38px"></th><th class="th-name">Spiller</th>`;
  for(let i=1;i<=numQ;i++) hh+=`<th class="td-q" style="font-size:.58rem">${i}</th>`;
  hh+=`<th class="th-score">Score</th>`;
  head.innerHTML=hh;

  if(!players.length){
    body.innerHTML=`<tr><td class="td-empty" colspan="${numQ+3}">Venter p√• spillere‚Ä¶ üéÆ</td></tr>`;
    return;
  }

  body.innerHTML=players.map((p,i)=>{
    const rank=i+1;
    const isLeader=i===0;
    const isNew=newName&&p.name.toLowerCase().trim()===newName.toLowerCase().trim();
    const rankStr=rank===1?'ü•á':rank===2?'ü•à':rank===3?'ü•â':rank;
    const rounds=Array.isArray(p.rounds)?p.rounds:[];
    const streak=getStreak(rounds);
    const fireStr=streak>=3?`<span class="streak-fire" title="${streak} p√• rad!">üî•${streak>=5?streak:''}</span>`:'';

    // Progress indicator
    const totalQ=maxQ||20;
    const curQ=p.currentQ||rounds.length;
    const progPct=Math.round(curQ/totalQ*100);
    const isDone=p.finished||curQ>=totalQ;
    const progHtml=!isDone
      ? `<span class="prog-bar-wrap"><span class="prog-bar-fill" style="width:${progPct}%"></span></span>`
      : '';

    let checks='';
    for(let q=0;q<numQ;q++){
      const r=rounds[q];
      if(!r) checks+=`<td class="td-q"><span class="ck blank">¬∑</span></td>`;
      else checks+=`<td class="td-q"><span class="ck ${r.correct?'ok':'no'}">${r.correct?'‚úì':'‚úó'}</span></td>`;
    }
    const sid=`ts_${slugify(p.name)}`;
    return `<tr class="${isLeader?'leader-row':''}${isNew?' new-flash':''}" id="tr_${slugify(p.name)}">
      <td class="td-rank">${rankStr}</td>
      <td class="td-name">${esc(p.name)}${fireStr}${progHtml}</td>
      ${checks}
      <td class="td-score" id="${sid}">${p.score} pts</td>
    </tr>`;
  }).join('');

  // Animate changed scores
  players.forEach(p=>{
    const key=slugify(p.name);
    const el=document.getElementById(`ts_${key}`);
    if(!el) return;
    const prev=prevScores[key]??p.score;
    if(prev!==p.score){ animCount(el, prev, p.score); }
    prevScores[key]=p.score;
  });
}

// ‚îÄ‚îÄ HALFTIME OVERLAY ‚îÄ‚îÄ
function showHalftimeOverlay(players){
  const medals=['ü•á','ü•à','ü•â'];
  document.getElementById('halftimeList').innerHTML=players.map((p,i)=>`
    <div class="halftime-row" style="animation-delay:${i*0.12}s">
      <div class="halftime-medal">${medals[i]||'#'+(i+1)}</div>
      <div class="halftime-name">${esc(p.name)}</div>
      <div class="halftime-progress">${p.currentQ||0}/10 spm</div>
    </div>`).join('');
  document.getElementById('halftimeOverlay').classList.add('open');
}

// ‚îÄ‚îÄ GAME STATE LISTENER ‚îÄ‚îÄ
onValue(ref(db,'gameState'), snapshot=>{
  document.getElementById('connecting').classList.add('hidden');
  const state=snapshot.val()||'waiting';
  currentGameState=state;

  // Update host panel
  const labels={waiting:'‚è≥ venter',countdown:'üö¶ nedtelling',playing:'‚ñ∂ spiller',halftime:'‚è∏ halvtid',finished:'üèÅ ferdig'};
  document.getElementById('hostStateLabel').textContent=labels[state]||state;
  document.getElementById('btnStart').disabled=state!=='waiting';
  document.getElementById('btnHalftime').disabled=state!=='playing';
  document.getElementById('btnFinish').disabled=!['playing','halftime'].includes(state);
  document.getElementById('btnResume').style.display=state==='halftime'?'block':'none';

  // Waiting overlay
  if(state==='waiting'){
    document.getElementById('waitingOverlay').classList.remove('hidden');
  } else {
    document.getElementById('waitingOverlay').classList.add('hidden');
  }

  // Countdown
  if(state==='countdown'){
    showCountdown(5, ()=>set(ref(db,'gameState'),'playing'));
  }

  // Halftime
  if(state==='halftime'){
    // Will show with current player data next render cycle
  } else {
    document.getElementById('halftimeOverlay').classList.remove('open');
  }
});

// ‚îÄ‚îÄ SCORES LISTENER ‚îÄ‚îÄ
onValue(ref(db,'scores'), snapshot=>{
  document.getElementById('connecting').classList.add('hidden');
  const data=snapshot.val();

  // Update waiting overlay player count
  const wCount=data?Object.keys(data).length:0;
  document.getElementById('waitPlayerCount').textContent=wCount;

  if(!data){
    document.getElementById('playerCount').textContent='0';
    return;
  }

  // Deduplicate: best score per name
  const byName={};
  Object.values(data).forEach(e=>{
    if(!e.name) return;
    const k=e.name.toLowerCase().trim();
    if(!byName[k]||e.score>byName[k].score) byName[k]=e;
  });

  const players=Object.values(byName).sort((a,b)=>b.score-a.score);
  document.getElementById('playerCount').textContent=players.length;

  players.forEach(p=>{ if(p.rounds) numQ=Math.max(numQ,Array.isArray(p.rounds)?p.rounds.length:0); });

  const newName=players.length>prevCount?players.find(p=>!prevScores.hasOwnProperty(slugify(p.name)))?.name:null;
  prevCount=players.length;

  const leader=players[0]?.name?.toLowerCase().trim();
  if(leader&&leader!==prevLeader&&prevLeader!==null) launchConfetti();
  prevLeader=leader;

  // Show halftime overlay if in halftime state
  if(currentGameState==='halftime'){
    showHalftimeOverlay(players);
  }

  renderPodium(players);
  const maxQ=Math.max(...players.map(p=>p.currentQ||0), numQ);
  renderTable(players, newName, maxQ);
});
</script>
</body>
</html>
